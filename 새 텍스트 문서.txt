import streamlit as st
import pandas as pd
import os

# --- ì„¤ì • ë° ë°ì´í„° ë¡œë“œ ---
FILE_NAME = 'books_data.csv'

# ë°ì´í„° íŒŒì¼ì´ ì—†ìœ¼ë©´ ë¹ˆ ë°ì´í„°í”„ë ˆì„ ìƒì„±
if not os.path.exists(FILE_NAME):
    df = pd.DataFrame(columns=['ì œëª©', 'ë ˆë²¨', 'ì½ì€íšŸìˆ˜', 'ìƒíƒœ', 'í‘œì§€URL'])
    df.to_csv(FILE_NAME, index=False)
else:
    df = pd.read_csv(FILE_NAME)

# --- UI ì„¤ì • ---
st.set_page_config(page_title="ì˜ì–´ì±… ê´€ë¦¬ ë§¤ë‹ˆì €", layout="wide")

st.title("ğŸ“š ìš°ë¦¬ ì•„ì´ ì˜ì–´ì±… ê´€ë¦¬ ë§¤ë‹ˆì €")
st.markdown("ì—„ë§ˆí‘œ ì˜ì–´ ë…ì„œ ê¸°ë¡ì¥ì…ë‹ˆë‹¤.")

# íƒ­ êµ¬ì„±: ë“±ë¡í•˜ê¸° / ê´€ë¦¬í•˜ê¸°
tab1, tab2 = st.tabs(["â• ìƒˆ ì±… ë“±ë¡", "ğŸ“– ì„œì¬ ê´€ë¦¬ (ë¦¬ìŠ¤íŠ¸)"])

# --- [íƒ­ 1] ìƒˆ ì±… ë“±ë¡ ê¸°ëŠ¥ ---
with tab1:
    st.subheader("ìƒˆë¡œìš´ ì±… ì¶”ê°€í•˜ê¸°")
    
    with st.form("add_book_form", clear_on_submit=True):
        col1, col2 = st.columns(2)
        with col1:
            title = st.text_input("ì±… ì œëª©")
            level = st.selectbox("ë‚œì´ë„ ë‹¨ê³„", [1, 2, 3, 4, 5], help="1ë‹¨ê³„(ì‰¬ì›€) ~ 5ë‹¨ê³„(ì–´ë ¤ì›€)")
        with col2:
            img_url = st.text_input("ì±… í‘œì§€ ì´ë¯¸ì§€ URL", placeholder="http://... (ì´ë¯¸ì§€ ì£¼ì†Œ ë¶™ì—¬ë„£ê¸°)")
            status = st.radio("í˜„ì¬ ìƒíƒœ", ["ì½ì§€ ì•ŠìŒ", "ì½ëŠ” ì¤‘", "ì™„ë…"])
        
        submitted = st.form_submit_button("ì±… ë“±ë¡í•˜ê¸°")
        
        if submitted and title:
            new_data = {
                'ì œëª©': title, 
                'ë ˆë²¨': level, 
                'ì½ì€íšŸìˆ˜': 0, 
                'ìƒíƒœ': status, 
                'í‘œì§€URL': img_url if img_url else "https://via.placeholder.com/150?text=No+Image" # ì´ë¯¸ì§€ ì—†ìœ¼ë©´ ê¸°ë³¸ ì´ë¯¸ì§€
            }
            # ë°ì´í„° ì¶”ê°€ ë° ì €ì¥
            df = pd.concat([df, pd.DataFrame([new_data])], ignore_index=True)
            df.to_csv(FILE_NAME, index=False)
            st.success(f"'{title}' ë“±ë¡ ì™„ë£Œ!")
            st.rerun() # í™”ë©´ ê°±ì‹ 

# --- [íƒ­ 2] ì„œì¬ ê´€ë¦¬ (ë¦¬ìŠ¤íŠ¸ & ìˆ˜ì •) ---
with tab2:
    st.subheader("í˜„ì¬ ë³´ìœ  ë„ì„œ í˜„í™©")

    # í•„í„°ë§ ê¸°ëŠ¥
    col_filter1, col_filter2 = st.columns(2)
    with col_filter1:
        filter_level = st.multiselect("ë ˆë²¨ë³„ ëª¨ì•„ë³´ê¸°", [1, 2, 3, 4, 5], default=[1, 2, 3, 4, 5])
    with col_filter2:
        filter_status = st.multiselect("ìƒíƒœë³„ ëª¨ì•„ë³´ê¸°", ["ì½ì§€ ì•ŠìŒ", "ì½ëŠ” ì¤‘", "ì™„ë…"], default=["ì½ì§€ ì•ŠìŒ", "ì½ëŠ” ì¤‘", "ì™„ë…"])

    # ë°ì´í„° í•„í„°ë§ ì ìš©
    filtered_df = df[df['ë ˆë²¨'].isin(filter_level) & df['ìƒíƒœ'].isin(filter_status)]

    # ê·¸ë¦¬ë“œ í˜•íƒœë¡œ ë³´ì—¬ì£¼ê¸° (PCì—ì„œëŠ” í•œ ì¤„ì— 3ê°œ, ëª¨ë°”ì¼ì€ 1ê°œì”© ë³´ì„)
    if not filtered_df.empty:
        # ì¸ë±ìŠ¤ë¥¼ ë¦¬ì…‹í•˜ì—¬ ìˆœíšŒ
        for i, row in filtered_df.iterrows():
            # ì¹´ë“œë¥¼ êµ¬ë¶„í•˜ê¸° ìœ„í•œ ì»¨í…Œì´ë„ˆ
            with st.container():
                c1, c2 = st.columns([1, 4])
                
                # ì™¼ìª½: í‘œì§€ ì´ë¯¸ì§€
                with c1:
                    try:
                        st.image(row['í‘œì§€URL'], width=100)
                    except:
                        st.error("ì´ë¯¸ì§€ ì˜¤ë¥˜")

                # ì˜¤ë¥¸ìª½: ì •ë³´ ë° ì¡°ì‘ ë²„íŠ¼
                with c2:
                    st.markdown(f"### {row['ì œëª©']} (Lv.{row['ë ˆë²¨']})")
                    st.info(f"í˜„ì¬ ìƒíƒœ: **{row['ìƒíƒœ']}** | ğŸ’¯ ì½ì€ íšŸìˆ˜: **{row['ì½ì€íšŸìˆ˜']}íšŒ**")
                    
                    # ì¡°ì‘ ë²„íŠ¼ë“¤ (í•œ ì¤„ì— ë°°ì¹˜)
                    b1, b2, b3 = st.columns(3)
                    if b1.button("â• 1íšŒ ì½ê¸° ì¶”ê°€", key=f"add_{i}"):
                        df.at[i, 'ì½ì€íšŸìˆ˜'] += 1
                        # ìƒíƒœê°€ 'ì½ì§€ ì•ŠìŒ'ì´ë©´ 'ì½ëŠ” ì¤‘'ìœ¼ë¡œ ìë™ ë³€ê²½ ë¡œì§
                        if df.at[i, 'ìƒíƒœ'] == 'ì½ì§€ ì•ŠìŒ':
                            df.at[i, 'ìƒíƒœ'] = 'ì½ëŠ” ì¤‘'
                        df.to_csv(FILE_NAME, index=False)
                        st.rerun()
                    
                    if b2.button("âœ… ì™„ë… ì²˜ë¦¬", key=f"finish_{i}"):
                        df.at[i, 'ìƒíƒœ'] = 'ì™„ë…'
                        df.to_csv(FILE_NAME, index=False)
                        st.rerun()

                    if b3.button("ğŸ—‘ ì‚­ì œ", key=f"del_{i}"):
                        df = df.drop(i)
                        df.to_csv(FILE_NAME, index=False)
                        st.rerun()
                st.divider() # êµ¬ë¶„ì„ 
    else:
        st.info("ì¡°ê±´ì— ë§ëŠ” ì±…ì´ ì—†ìŠµë‹ˆë‹¤.")